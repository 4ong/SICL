\chapter{Processing arguments}

In this chapter, we describe how processing arguments is accomplished
by inserting HIR instructions immediately after HIR code is generated
from an abstract syntax tree.  By doing it this way, we obtain several
advantages:

\begin{itemize}
\item We simplify the translation of HIR code to LIR later on the
  translation process.
\item HIR transformations such as constant hoisting and
  \texttt{fdefinition} hoisting can be applied to the
  argument-processing code, thereby simplifying this code.
\item The HIR instructions introduced are subject to various HIR
  transformations such as value numbering, constant propagation,
  etc.
\end{itemize}

Each type of parameter is is handled by a different module.  In
addition, because of the complexity of initializing keyword
parameters, that module is is further subdivided.

Two new HIR instructions are used in order to accomplish the argument
processing:

\begin{itemize}
\item The \texttt{compute-argument-count-instruction} has no inputs,
  and a single output.  It is responsible for computing the total
  number of arguments passed to the function.
\item The \texttt{argument-instruction} has one input and one output.
  The input is a datum that must be a non-negative fixnum.  The output
  is the argument with an index represented by the value of the input,
  starting at $0$ for the first argument.
\end{itemize}

The overall organization of the modules for initializing parameters is
shown in \refFig{fig-process-arguments}.

\begin{figure}
\begin{center}
\inputfig{fig-process-arguments.pdf_t}
\end{center}
\caption{\label{fig-process-arguments}
Processing all arguments.}
\end{figure}

\begin{figure}
\begin{center}
\inputfig{fig-check-minimum-argument-count.pdf_t}
\end{center}
\caption{\label{fig-check-minimum-argument-count}
Checking minimum argument count.}
\end{figure}

\begin{figure}
\begin{center}
\inputfig{fig-check-maximum-argument-count.pdf_t}
\end{center}
\caption{\label{fig-check-maximum-argument-count}
Checking maximum argument count.}
\end{figure}

\begin{figure}
\begin{center}
\inputfig{fig-initialize-required-parameters.pdf_t}
\end{center}
\caption{\label{fig-initialize-required-parameters}
Initializing required parameters.}
\end{figure}

\begin{figure}
\begin{center}
\inputfig{fig-initialize-optional-parameters.pdf_t}
\end{center}
\caption{\label{fig-initialize-optional-parameters}
Initializing optional parameters.}
\end{figure}

\begin{figure}
\begin{center}
\inputfig{fig-no-more-arguments.pdf_t}
\end{center}
\caption{\label{fig-no-more-arguments}
Initializing keyword parameters to \texttt{nil}.}
\end{figure}

\begin{figure}
\begin{center}
\inputfig{fig-create-rest-parameter.pdf_t}
\end{center}
\caption{\label{fig-create-rest-parameter}
Creating the rest parameter.}
\end{figure}

\begin{figure}
\begin{center}
\inputfig{fig-process-keyword-arguments.pdf_t}
\end{center}
\caption{\label{fig-process-keyword-arguments}
Processing keyword arguments.}
\end{figure}

\begin{figure}
\begin{center}
\inputfig{fig-check-even-keyword-arguments.pdf_t}
\end{center}
\caption{\label{fig-check-even-keyword-arguments}
Checking that there is an even number of keyword arguments.}
\end{figure}

\begin{figure}
\begin{center}
\inputfig{fig-initialize-one-keyword-parameter.pdf_t}
\end{center}
\caption{\label{fig-initialize-one-keyword-parameter}
Initializing one keyword parameter.}
\end{figure}

\begin{figure}
\begin{center}
\inputfig{fig-check-allow-other-keys.pdf_t}
\end{center}
\caption{\label{fig-check-allow-other-keys}
Checking for \texttt{:allow-other-keys}}
\end{figure}

\begin{figure}
\begin{center}
\inputfig{fig-check-every-keyword.pdf_t}
\end{center}
\caption{\label{fig-check-every-keyword}
Checking the validity of every keyword.}
\end{figure}
